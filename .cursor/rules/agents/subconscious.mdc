---
description: Subconscious Agent (–ü—ñ–¥—Å–≤—ñ–¥–æ–º—ñ—Å—Ç—å) patterns - Phase 2 (Not Yet Implemented)
alwaysApply: false
---
# SUBCONSCIOUS AGENT (–ü–Ü–î–°–í–Ü–î–û–ú–Ü–°–¢–¨) RULES

**Status:** üöß **NOT IMPLEMENTED** - —Ü–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –º–∞–π–±—É—Ç–Ω—å–æ—ó —ñ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—ó

---

## Purpose

–ü—ñ–¥—Å–≤—ñ–¥–æ–º—ñ—Å—Ç—å - –¥—Ä—É–≥–∏–π –∞–≥–µ–Ω—Ç, —è–∫–∏–π –∞–Ω–∞–ª—ñ–∑—É—î –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑ —ñ—Å—Ç–æ—Ä—ñ—ó –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —Ç–∞ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ñ –∑–≤'—è–∑–∫–∏ –¥–ª—è —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É.

**–ú–µ—Ç–∞—Ñ–æ—Ä–∞:** –ö–æ–ª–µ–∫—Ç–∏–≤–Ω–∞ –ø–∞–º'—è—Ç—å, —è–∫–∞ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω–∏ —Ç–∞ –∑–≤'—è–∑–∫–∏ –º—ñ–∂ –ø–æ–¥—ñ—è–º–∏.

---

## Responsibility

### ‚úÖ –¢–Ü–õ–¨–ö–ò –¶–ï:

1. **–ß–∏—Ç–∞—Ç–∏ –Ω–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è** –∑ state (–≤—ñ–¥ Clerk)
2. **–®—É–∫–∞—Ç–∏ —Å—Ö–æ–∂—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è** –≤ —ñ—Å—Ç–æ—Ä—ñ—ó —á–µ—Ä–µ–∑ semantic search
3. **–ó–Ω–∞—Ö–æ–¥–∏—Ç–∏ –∑–≤'—è–∑–∫–∏** (—Ç–µ–º–∞—Ç–∏—á–Ω—ñ, —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–∏, –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å)
4. **–§–æ—Ä–º—É–≤–∞—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç** –¥–ª—è Orchestrator
5. **–°—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ relationships** –≤ –≥—Ä–∞—Ñ—ñ (REFERENCES, FOLLOWS)

### ‚ùå –ó–ê–ë–û–†–û–ù–ï–ù–û:

- ‚ùå –ó–∞–ø–∏—Å—É–≤–∞—Ç–∏ –Ω–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (—Ü–µ Clerk)
- ‚ùå –ü—Ä–∏–π–º–∞—Ç–∏ —Ä—ñ—à–µ–Ω–Ω—è (—Ü–µ Orchestrator)
- ‚ùå –ì–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
- ‚ùå –í–∏–∫–ª–∏–∫–∞—Ç–∏ Gemini API

---

## Module Structure (Planned)

```
backend/app/agents/subconscious/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ nodes.py              # subconscious_analyze_node
‚îú‚îÄ‚îÄ analyzer.py           # ContextAnalyzer class
‚îú‚îÄ‚îÄ embeddings.py         # Embedding generation
‚îú‚îÄ‚îÄ similarity.py         # Similarity calculations
‚îî‚îÄ‚îÄ schemas.py            # ContextAnalysis model
```

---

## Technologies

### Embedding Models

**Options:**
1. **OpenAI Embeddings** - text-embedding-3-small
2. **Local models** - sentence-transformers
3. **Gemini Embeddings** - text-embedding-004

**Recommendation:** Start with Gemini (already integrated)

### Vector Similarity

**In FalkorDB:**
```cypher
// Store embeddings
CREATE (m:Message {
    content: "...",
    embedding: [0.1, 0.2, ...]  // Array of floats
})

// Similarity search (future FalkorDB feature?)
MATCH (m1:Message), (m2:Message)
WITH m1, m2, vector.similarity(m1.embedding, m2.embedding) as sim
WHERE sim > 0.7
RETURN m1, m2, sim
```

**Alternative:** Store embeddings in Redis/Weaviate, IDs –≤ FalkorDB.

---

## Node Implementation Pattern

```python
async def subconscious_analyze_node(
    state: dict, 
    repository: MessageRepository,
    analyzer: ContextAnalyzer
) -> dict:
    """Analyze context and find relations."""
    
    logger.info("üß† –ü—ñ–¥—Å–≤—ñ–¥–æ–º—ñ—Å—Ç—å: –ê–Ω–∞–ª—ñ–∑—É—é –∫–æ–Ω—Ç–µ–∫—Å—Ç...")
    
    try:
        # 1. Get message from Clerk
        message_id = state["message_id"]
        if not state["recorded"]:
            logger.warning("‚ö†Ô∏è Message not recorded, skipping analysis")
            return state
        
        # 2. Analyze
        analysis = await analyzer.analyze_message(
            message_id=message_id,
            session_id=state["session_id"]
        )
        
        # 3. Update state
        state["context"] = analysis.context
        state["related_messages"] = analysis.related_message_ids
        state["semantic_similarity"] = analysis.avg_similarity
        
        logger.info(
            f"üß† –ü—ñ–¥—Å–≤—ñ–¥–æ–º—ñ—Å—Ç—å: –ó–Ω–∞–π–¥–µ–Ω–æ {len(analysis.related_message_ids)} "
            f"–∑–≤'—è–∑–∫—ñ–≤ (similarity={analysis.avg_similarity:.2f})"
        )
        
    except Exception as e:
        logger.error(f"üß† –ü—ñ–¥—Å–≤—ñ–¥–æ–º—ñ—Å—Ç—å: –ü–æ–º–∏–ª–∫–∞ –∞–Ω–∞–ª—ñ–∑—É: {e}")
        # Graceful degradation - empty context
        state["context"] = {}
        state["related_messages"] = []
    
    return state
```

---

## Context Analysis Strategy

### 1. Recent History

```python
# –û—Å—Ç–∞–Ω–Ω—ñ N –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —Å–µ—Å—ñ—ó
cypher = """
MATCH (m:Message)-[:IN_SESSION]->(s:ChatSession {id: $session_id})
RETURN m.id, m.content, m.timestamp
ORDER BY m.timestamp DESC
LIMIT $limit
"""
```

### 2. Semantic Similarity

```python
# –ó–Ω–∞–π—Ç–∏ —Å—Ö–æ–∂—ñ –ø–æ embedding
similar_messages = await find_similar_by_embedding(
    current_embedding,
    threshold=0.7,
    limit=10
)
```

### 3. Relationship Creation

```python
# –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–≤'—è–∑–∫–∏ –≤ –≥—Ä–∞—Ñ—ñ
cypher = """
MATCH (m1:Message {id: $message_id})
MATCH (m2:Message {id: $related_id})
CREATE (m1)-[:REFERENCES {similarity: $similarity}]->(m2)
"""
```

---

## State Contract

### Subconscious Provides

```python
state["context"] = {
    "recent_messages": [...],      # –û—Å—Ç–∞–Ω–Ω—ñ 5-10 messages
    "similar_messages": [...],     # –°—Ö–æ–∂—ñ –ø–æ —Ç–µ–º—ñ
    "topics": ["history", "war"],  # –í–∏—è–≤–ª–µ–Ω—ñ —Ç–µ–º–∏
    "entities": ["Kozak", "Sich"], # Named entities
}

state["related_messages"] = ["msg1", "msg2"]  # IDs
state["semantic_similarity"] = 0.82  # Average
```

### Orchestrator Will Use

```python
context = state["context"]
recent = context["recent_messages"]
topics = context["topics"]

# Build prompt for Gemini with context
prompt = f"User asked: {user_msg}\nContext: {recent}\nTopics: {topics}"
```

---

## Performance Targets

**Analysis time:** < 500ms  
**Embedding generation:** ~100-200ms  
**Similarity search:** ~50-100ms  
**Graph traversal:** ~50-100ms

**Total:** ~300-500ms per message

---

## Future Enhancements

### Phase 2.1: Basic Context
- Recent messages (last 10)
- Simple keyword matching

### Phase 2.2: Semantic Search
- Embedding generation
- Vector similarity
- Cosine distance

### Phase 2.3: Graph Analysis
- FOLLOWS relationships
- Topic clustering
- Entity extraction

---

**Version:** 0.1.0 (Planning)  
**Status:** NOT IMPLEMENTED  
**Blocked by:** Phase 1 completion  
**Target:** Phase 2
